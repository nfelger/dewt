!function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);class r{constructor(e,...t){this.maybeRemove()&&(r.element=this.createElement(...t),e.appendChild(r.element))}createElement(){throw new Error("Not implemented! Override in subclass.")}isPristine(){return Array.from(r.element.querySelectorAll("input, textarea")).every(e=>e.defaultValue===e.value)}maybeRemove(){return!r.element||(this.isPristine()?(this.remove(),!0):(this.flash(),!1))}remove(){r.element.remove(),r.element=null}flash(){r.element.classList.add("box-flash"),setTimeout(()=>{r.element&&r.element.classList.remove("box-flash")},800)}}class a extends r{createElement(e,t){let n=document.createElement("article");n.classList.add("timebox","timebox-draft"),n.style.setProperty("--start-minute",e),n.style.setProperty("--end-minute",t),n.insertAdjacentHTML("beforeend",'\n      <form action="">\n        <textarea name="details" placeholder="Work on something deeply"></textarea>\n        <button type="submit"></button>\n      </form>\n      <div class="closeBtn">Ã—</div>\n    ');const r=n.querySelector("textarea");r.addEventListener("input",()=>{const e="\n"===r.value.slice(-1);r.value=r.value.replace(/\n/g,""),""!==r.value&&e&&n.querySelector("form").requestSubmit()});return n.querySelector(".closeBtn").addEventListener("click",e=>{e.stopPropagation(),this.remove()}),n.addEventListener("keydown",e=>{"Escape"==e.key&&this.remove()}),n.addEventListener("click",e=>e.stopPropagation()),n}}function o(e){return e<10?"0"+e:""+e}function i(e){var t,n;return(t=e,n=60,[Math.floor(t/n),t%n]).map(o).join(":")}function s(e){const[t,n]=e.split(":").map(Number);return 60*t+n}function l(e){return`${e.getFullYear()}-${o(e.getMonth()+1)}-${o(e.getDate())}`}function d(e){return e.replace(/-(\w|$)/g,(e,t)=>t.toUpperCase())}function c(e,t){return()=>{let n;n=s(e.value)>=s(t.value)?"Start can't be after end.":"",e.setCustomValidity(n),t.setCustomValidity(n)}}class u extends r{createElement(e,t){let n=document.createElement("div");n.className="timebox-edit",n.dataset.timeboxId=e,n.insertAdjacentHTML("beforeend",`\n      <form action="">\n        <fieldset>\n          <ul>\n            <li class="project">\n              <label for="project">Project</label>\n              <input type="text" name="project" value="${t.project||""}">\n            </li>\n            <li class="details">\n              <label for="details">Details</label>\n              <input type="text" name="details" required value="${t.details}">\n            </li>\n          </ul>\n        </fieldset>\n        <fieldset>\n          <ul>\n            <li class="start-minute">\n              <label for="start-minute">Start</label>\n              <input type="text" name="start-minute" required pattern="(2[0-3]|[0-1]?\\d):[0-5]\\d" title="hh:mm (24h time)" value="${i(t.startMinute)}">\n            </li>\n            <li class="end-minute">\n              <label for="end-minute">End</label>\n              <input type="text" name="end-minute" required pattern="(2[0-3]|[0-1]?\\d):[0-5]\\d" title="hh:mm (24h time)" value="${i(t.endMinute)}">\n            </li>\n            <li class="date">\n              <label for="date">Date</label>\n              <input type="text" name="date" required pattern="\\d{4}-\\d{2}-\\d{2}" title="yyyy-mm-dd" value="${t.date}">\n            </li>\n          </ul>\n        </fieldset>\n        <fieldset>\n          <ul>\n            <li class="theme-color">\n              <label for="theme-color">Color</label>\n              <input type="text" name="theme-color" required pattern="[1-7]" title="any number from 1 to 7" value="${t.themeColor}">\n            </li>\n          </ul>\n        </fieldset>\n        <fieldset>\n          <ul>\n            <li class="delete-timebox"><a href="#">Delete</a></li>\n            <li class="cancel"><a href="#">Cancel</a></li>\n            <li><button type="submit">Save</button></li>\n          </ul>\n        </fieldset>\n      </form>`),n.querySelector(".cancel a").addEventListener("click",e=>{e.preventDefault(),this.remove()}),n.addEventListener("click",e=>e.stopPropagation());const r=n.querySelector("form"),[a,o]=r.querySelectorAll("input[name=start-minute], input[name=end-minute]");return a.addEventListener("input",c(a,o)),o.addEventListener("input",c(a,o)),n}}class m extends r{createElement(e,t){let n=document.createElement("div");n.className="work-hours-modal",n.insertAdjacentHTML("beforeend",`\n      <p>Set your working hours:</p>\n      <form action="">\n        <fieldset>\n          <ul>\n            <li class="work-start">\n              <label for="start">Start</label>\n              <input type="text" name="start" required pattern="(2[0-3]|[0-1]?\\d):[0-5]\\d" title="hh:mm (24h time)" value="${i(e)}">\n            </li>\n            <li class="work-end">\n              <label for="end">End</label>\n              <input type="text" name="end" required pattern="(2[0-3]|[0-1]?\\d):[0-5]\\d" title="hh:mm (24h time)" value="${i(t)}">\n            </li>\n          </ul>\n        </fieldset>\n        <fieldset>\n          <ul>\n            <li><a href="#">Cancel</a></li>\n            <li><button type="submit">Save</button></li>\n          </ul>\n        </fieldset>\n      </form>`),n.addEventListener("click",e=>e.stopPropagation()),n.querySelector("a").addEventListener("click",e=>{e.preventDefault(),this.remove()}),n.addEventListener("keydown",e=>{"Escape"==e.key&&this.remove()});const r=n.querySelector("form"),[a,o]=r.querySelectorAll("input[name=start], input[name=end]");return a.addEventListener("input",c(a,o)),o.addEventListener("input",c(a,o)),n}}let f,p;const y=new WeakMap,h=new WeakMap,w=new WeakMap,v=new WeakMap,b=new WeakMap;let g={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return h.get(e);if("objectStoreNames"===t)return e.objectStoreNames||w.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return S(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function E(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(p||(p=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(x(this),t),S(y.get(this))}:function(...t){return S(e.apply(x(this),t))}:function(t,...n){const r=e.call(x(this),t,...n);return w.set(r,t.sort?t.sort():[t]),S(r)}}function M(e){return"function"==typeof e?E(e):(e instanceof IDBTransaction&&function(e){if(h.has(e))return;const t=new Promise((t,n)=>{const r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",o),e.removeEventListener("abort",o)},a=()=>{t(),r()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",o),e.addEventListener("abort",o)});h.set(e,t)}(e),t=e,(f||(f=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some(e=>t instanceof e)?new Proxy(e,g):e);var t}function S(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,n)=>{const r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",o)},a=()=>{t(S(e.result)),r()},o=()=>{n(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",o)});return t.then(t=>{t instanceof IDBCursor&&y.set(t,e)}).catch(()=>{}),b.set(t,e),t}(e);if(v.has(e))return v.get(e);const t=M(e);return t!==e&&(v.set(e,t),b.set(t,e)),t}const x=e=>b.get(e);const D=["get","getKey","getAll","getAllKeys","count"],L=["put","add","delete","clear"],P=new Map;function k(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(P.get(t))return P.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,a=L.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!a&&!D.includes(n))return;const o=async function(e,...t){const o=this.transaction(e,a?"readwrite":"readonly");let i=o.store;r&&(i=i.index(t.shift()));const s=await i[n](...t);return a&&await o.done,s};return P.set(t,o),o}async function C(){return await function(e,t,{blocked:n,upgrade:r,blocking:a,terminated:o}={}){const i=indexedDB.open(e,t),s=S(i);return r&&i.addEventListener("upgradeneeded",e=>{r(S(i.result),e.oldVersion,e.newVersion,S(i.transaction))}),n&&i.addEventListener("blocked",()=>n()),s.then(e=>{o&&e.addEventListener("close",()=>o()),a&&e.addEventListener("versionchange",()=>a())}).catch(()=>{}),s}("dewt",1,{upgrade(e){const t=e.createObjectStore("timeboxes",{keyPath:"id",autoIncrement:!0});for(let e of["project","details","themeColor","startMinute","endMinute","date"])t.createIndex(e,e,{unique:!1});e.createObjectStore("workhours",{keyPath:"id",autoIncrement:!0}).createIndex("date","date")}})}async function j(e){const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1),r=l(t),a=[{project:"writing",details:"Aufsatz zur Verwandlung von Pangolinen",themeColor:1,date:r,startMinute:570,endMinute:670,id:1},{project:"Dewt",details:"Dewt Namen finden",themeColor:2,date:r,startMinute:683,endMinute:765,id:2},{project:"I SHOULD",details:"NOT APPEAR",themeColor:3,date:l(n),startMinute:540,endMinute:900,id:3},{project:null,details:"Email",themeColor:1,date:r,startMinute:765,endMinute:900,id:4}];for(let t of a)await e.get("timeboxes",t.id)&&await e.delete("timeboxes",t.id),await e.put("timeboxes",t)}g=(e=>({...e,get:(t,n,r)=>k(t,n)||e.get(t,n,r),has:(t,n)=>!!k(t,n)||e.has(t,n)}))(g);const A=C(),q="error",I=document.querySelector(".notifications");function T(e,t){const n=document.createElement("div");n.classList.add("notification",t),I.appendChild(n);const r=document.createElement("p");r.textContent=e,n.appendChild(r),n.addEventListener("click",()=>{n.classList.add("hide"),setTimeout((function(){n.remove()}),200)})}async function B(e,t){return await e.getAllFromIndex("timeboxes","date",l(t))}async function N(e,t){return await e.get("timeboxes",Number(t))}const _="Timeboxes can't overlap. Try adjusting start / end times.";async function O(e,t){const n=[],r=await B(e,new Date);for(let e of r)e.id!==t.id&&(t.startMinute>=e.startMinute&&t.startMinute<e.endMinute||t.endMinute>=e.startMinute&&t.endMinute<e.endMinute)&&(n.includes(_)||n.push(_));if(n.length>0){for(let e of n)T(e,q);throw new Error("Timebox validation failed.")}return n===[]}const $=new class{constructor(e,t,n){this.agendaElement=e,this.totalMinutes=t,this.dayStartsAtMin=n,this.dateStr=function(){const e=new URL(window.location.href).searchParams.get("date");if(null===e)return new Date;if(e.match(/\d{4}-\d{2}-\d{2}/)){const[t,n,r]=e.split("-").map(Number);return new Date(t,n-1,r)}throw document.querySelector("body").innerHTML="<h1>Page not found</h1><p>You really shouldn't be hereâ€¦</p>",Error("Malformed date! "+e)}()}draw(){this._setTotalMinutesOnAgendaElement(),this._drawCalendarDate(),this._drawHours(),this._drawMajorLines(),this._drawMinorLines(),this._drawNowRule()}_setTotalMinutesOnAgendaElement(){this.agendaElement.style.setProperty("--total-minutes",this.totalMinutes)}_drawCalendarDate(){const e={month:"short",weekday:"short"},[t,n]=new Intl.DateTimeFormat("en-US",e).formatToParts(this.dateStr).filter(({type:t})=>Object.keys(e).includes(t)).map(({value:e})=>e),r=this.dateStr.getDate(),a=document.querySelectorAll(".day p");a[0].textContent=t,a[1].textContent=r,a[2].textContent=n}_drawHours(){for(let e=60-this.dayStartsAtMin%60;e<this.totalMinutes;e+=60){const t=document.createElement("h3");t.className="time-hint",t.style.setProperty("--start-minute",e),t.style.setProperty("--end-minute",e+59),t.textContent=(this.dayStartsAtMin+e)/60;const n=document.createElement("sup");n.textContent="00",t.appendChild(n),this.agendaElement.appendChild(t)}}_drawMajorLines(){const e=60-this.dayStartsAtMin%60;this._drawLinesEvery60Min("rule-major",e)}_drawMinorLines(){let e;e=this.dayStartsAtMin%60<30?30-this.dayStartsAtMin%30:60-(this.dayStartsAtMin-30)%60,this._drawLinesEvery60Min("rule-minor",e)}_drawNowRule(){const e=document.createElement("div");e.className="rule-now",this.agendaElement.appendChild(e);const t=this.dayStartsAtMin,n=this.totalMinutes;!function r(){const a=new Date,o=60*a.getHours()+a.getMinutes()-t;o>=n?e.remove():(e.style.setProperty("--start-minute",o),setTimeout(r,6e4))}()}_drawLinesEvery60Min(e,t){for(let n=t;n<this.totalMinutes;n+=60){const t=document.createElement("div");t.className=e,t.style.setProperty("--start-minute",n),this.agendaElement.appendChild(t)}}}(document.querySelector(".agenda"),960,360);let R;$.draw();let V=new URL(window.location.href);function F(e){const t=document.querySelector(`article[data-timebox-id="${e.id}"]`);if(t&&t.remove(),e.date!==l(new Date))return;const n=document.createElement("article");n.classList.add("timebox","theme-color-"+e.themeColor),n.style.setProperty("--start-minute",e.startMinute-$.dayStartsAtMin),n.style.setProperty("--end-minute",e.endMinute-$.dayStartsAtMin);const r=document.createElement("h4");r.textContent=e.details,n.appendChild(r);const a=document.createElement("h5");a.textContent=e.project,n.appendChild(a),n.dataset.timeboxId=e.id,n.addEventListener("click",W),$.agendaElement.appendChild(n)}function H(e){if(R&&!R.maybeRemove())return;const t=(e-=$.dayStartsAtMin)+45;R=new a($.agendaElement,e,t),R.constructor.element.querySelector("form").addEventListener("submit",U),R.constructor.element.querySelector("textarea").focus()}async function W(e){if(e.stopPropagation(),R&&!R.maybeRemove())return;const t=e.currentTarget,n=t.dataset.timeboxId,r=await A,a=await N(r,n);R=new u(t,n,a),R.constructor.element.querySelector(".delete-timebox a").addEventListener("click",async e=>{e.preventDefault(),await async function(e,t){await e.delete("timeboxes",Number(t))}(r,n),R.remove(),t.remove()}),R.constructor.element.querySelector("form").addEventListener("submit",Y)}async function U(e){e.preventDefault();let t=null,n=new FormData(e.target).get("details");const r=n.indexOf(":");-1!==r&&(t=n.slice(0,r),n=n.slice(r+1));const a=await A;try{F(await async function(e,t){await O(e,t);const n=await e.put("timeboxes",t);return t.id=n,t}(a,{project:t,details:n,themeColor:1,date:l(new Date),startMinute:Number(R.constructor.element.style.getPropertyValue("--start-minute"))+$.dayStartsAtMin,endMinute:Number(R.constructor.element.style.getPropertyValue("--end-minute"))+$.dayStartsAtMin})),R.remove()}catch{R.flash()}}async function Y(e){e.preventDefault();if(!R.constructor.element.querySelector("form").reportValidity())return;const t=Array.from(R.constructor.element.querySelectorAll("input")).filter(e=>e.value!==e.defaultValue);let n={};for(let e of t){let t=e.value,r=d(e.name);switch(r){case"startMinute":case"endMinute":t=s(t);break;case"date":const[e,n,r]=t.split("-").map(Number);t=l(new Date(e,n-1,r))}n[r]=t}const r=R.constructor.element.dataset.timeboxId,a=await A;try{F(await async function(e,t,n){const r=await N(e,t);for(let[e,t]of Object.entries(n))r[e]=t;return await O(e,r),await e.put("timeboxes",r),r}(a,r,n)),R.remove()}catch{R.flash()}}async function K(e){e.preventDefault();const t=new FormData(e.target),n={date:l(new Date),startMinute:s(t.get("start")),endMinute:s(t.get("end"))},r=await A;await async function(e,t){const n=await e.getFromIndex("workhours","date",t.date);n&&(t.id=n.id);await e.put("workhours",t)}(r,n),R.remove(),G(r)}async function z(e,t){let n=await e.getFromIndex("workhours","date",t);return n||(n={date:t,startMinute:480,endMinute:1080}),n}async function G(e){const t=await z(e,l(new Date)),n=document.querySelector(".work-hours");n.style.setProperty("--start-minute",t.startMinute-$.dayStartsAtMin),n.style.setProperty("--end-minute",t.endMinute-$.dayStartsAtMin),$.agendaElement.appendChild(n)}null!==V.searchParams.get("wipeDbAndSeedTestData")&&A.then((async function(e){return e.close(),await function(e,{blocked:t}={}){const n=indexedDB.deleteDatabase(e);return t&&n.addEventListener("blocked",()=>t()),S(n).then(()=>{})}("dewt"),e=await C(),await j(e),e})).then(()=>{V.searchParams.delete("wipeDbAndSeedTestData"),window.location.href=V.href}),null!==V.searchParams.get("addTestData")&&A.then(j).then(()=>{V.searchParams.delete("addTestData"),window.location.href=V.href}),A.then((async function(e){const t=await B(e,new Date);for(let e of t)F(e)})),function(e){let t;e.agendaElement.addEventListener("mousemove",e=>{t=e.clientY}),e.agendaElement.addEventListener("click",n=>{const r=e.agendaElement.getBoundingClientRect().y;H(t-r+e.dayStartsAtMin)})}($),A.then(G),$.agendaElement.querySelector(".set-work-hours a").addEventListener("click",e=>{e.stopPropagation(),async function(){if(R&&!R.maybeRemove())return;const e=await A,t=await z(e,l(new Date));R=new m($.agendaElement,t.startMinute,t.endMinute),R.constructor.element.querySelector("form").addEventListener("submit",K),R.constructor.element.querySelector("input").focus()}()})}]);